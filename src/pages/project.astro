---
import '../styles/global.css'
import Layout from "../layouts/Layout.astro";

import AppHeader from '../components/Header.astro';
import AppFooter from '../components/Footer.astro';

// +++ DEFINE TYPES +++
// Define the type for a single project based on the API fields we use
interface Project {
  id: string;
  title: string;
  short_description: string;
  media: {
    images: string[];
  };
  metrics: {
    like_count: number;
  };
  dates: {
    created_at: string;
  };
  assignment: {
    order: number;
  };
}

// Define the type for the API response's 'data' key
interface ApiResponse {
  data: Project[];
}

// 1. Fetch project data from the NEW API endpoint
const response = await fetch("https://portfolio.triodedevs.workers.dev/public/user/tri_m006");
// +++ TYPE ASSERTION +++
// Tell TypeScript what shape to expect from the JSON response
const apiResponse = (await response.json()) as ApiResponse;

// 2. Access and sort.
//    Because apiResponse is typed, 'a' and 'b' are now
//    automatically inferred as 'Project'
const sortedProjects = apiResponse.data
  .sort((a, b) => a.assignment.order - b.assignment.order);

// Helper function with +++ TYPE ANNOTATION +++
function formatDate(dateString: string | null | undefined) {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}
---

<Layout>
    <AppHeader />
    
    <section class="py-40">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-15">
                <h1 class="title text-5xl font-black">Projects</h1>
            </div>
            <div class="p-3">
                {/* 'project' is now automatically inferred as 'Project' 
                  because sortedProjects is known to be a Project[]
                */}
                {sortedProjects.map((project) => {
                    const { id, title, short_description, media, metrics, dates } = project;
                    const imageUrl = media?.images?.[0];

                    return (
                        <a href={`/project/${id}`} class="flex flex-col sm:flex-row gap-5 items-start bg-white p-5 border-2 mb-5 transition-all duration-200 hover:shadow-[4px_4px_0px_rgba(0,0,0,0.3)]">
                            
                            <div class="flex-shrink-0 w-full sm:w-[200px]">
                                <div class="w-full h-[130px] overflow-hidden border-2">
                                    <img src={imageUrl} alt={`Cover image for ${title}`} class="w-full h-full object-cover" />
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2 flex-1 w-full">
                                <h1 class="line-clamp-2 text-xl font-bold">{title}</h1>
                                <div class="line-clamp-2 text-sm text-gray-700">{short_description}</div>
                                <div class="flex flex-wrap gap-4 justify-between items-center mt-3 pt-3 border-t">
                                    <span class="text-xs text-gray-500">
                                        Created: {formatDate(dates.created_at)}
                                    </span>
                                    <div class="flex items-center gap-4">
                                        <span class="flex items-center gap-1.5 text-sm text-gray-600">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-red-500">
                                              <path d="M9.653 16.915l-.005-.003-.019-.011a20.759 20.759 0 01-1.162-.682c-2.099-1.58-4.074-3.515-5.46-5.824C1.536 8.17 1.028 6.098 1.028 4.2c0-2.341 1.89-4.228 4.228-4.228 1.569 0 2.98.857 3.745 2.153a.75.75 0 001.496-.002c.766-1.296 2.176-2.153 3.745-2.153 2.338 0 4.228 1.887 4.228 4.228 0 1.898-.508 3.97-1.973 6.196-1.386 2.309-3.361 4.244-5.46 5.824a20.76 20.76 0 01-1.18 0.695z" />
                                            </svg>
                                            {metrics.like_count}
                                        </span>
                                        <div class="px-3 py-1 bg-blue-500 text-white rounded-md text-xs font-medium">
                                            Like
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    )
                })}
            </div>
        </div>
    </section>

    <AppFooter />
</Layout>