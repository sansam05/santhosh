---
// --- 1. IMPORTS & LAYOUT ---
import Layout from '../../layouts/Layout.astro';
import '../../styles/global.css';

// --- 2. TYPE DEFINITIONS (for TypeScript) ---
interface Project {
  id: string;
  title: string;
  description: string;
  links: {
    live: string | null;
    github: string | null;
    video: string | null;
    youtube: string | null;
  };
  media: {
    images: string[];
  };
  technical: {
    technologies: string[];
  };
  metrics: {
    like_count: number;
  };
  like_info: {
    user_has_liked: boolean;
    like_endpoint: string;
    method: string;
  };
  timeline: {
    created_at: string;
    updated_at: string;
  };
}

interface Review {
  id: string;
  reviewer_name: string;
  rating: number;
  title: string;
  content: string;
  created_at: string;
  is_visible: number;
}

interface ProjectApiResponse {
  success: boolean;
  data: Project;
}

interface ReviewApiResponse {
  reviews: Review[];
}

interface ProjectListApiResponse {
  success: boolean;
  data: Project[];
}

// --- This tells Astro to render this page on-demand (SSR) ---
export const prerender = false;

// --- 3. DATA FETCHING (for the page template) ---
const PROJECT_API_BASE = "https://portfolio.triodedevs.workers.dev";
const { id } = Astro.params;
if (!id) return Astro.redirect("/404");

let project: Project | null = null;
let reviews: Review[] = [];

try {
  const projectRes = await fetch(`${PROJECT_API_BASE}/public/${id}`);
  if (!projectRes.ok) throw new Error("Project not found");
  
  const projectApiData = (await projectRes.json()) as ProjectApiResponse;
  project = projectApiData.data;

  const reviewRes = await fetch(`https://portfolio.triodedevs.workers.dev/api/reviews?project_id=${id}`);
  if (reviewRes.ok) {
    const reviewApiData = (await reviewRes.json()) as ReviewApiResponse;
    reviews = reviewApiData.reviews.filter(review => review.is_visible === 1);
  }

} catch (error) {
  console.error("Error fetching data:", error);
  return Astro.redirect("/404");
}

if (!project) return Astro.redirect("/404");

// --- 4. HELPER FUNCTIONS ---
function formatDate(dateString: string) {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}

function getYoutubeEmbedUrl(url: string | null): string | null {
  if (!url) return null;
  try {
    const videoUrl = new URL(url);
    if (videoUrl.hostname === "youtu.be") {
      return `https://www.youtube.com/embed/${videoUrl.pathname.slice(1)}`;
    }
    if (videoUrl.hostname.includes("youtube.com") && videoUrl.searchParams.has("v")) {
      return `https://www.youtube.com/embed/${videoUrl.searchParams.get("v")}`;
    }
  } catch (e) {
    return null;
  }
  return null;
}
const youtubeEmbedUrl = getYoutubeEmbedUrl(project.links.youtube || project.links.video);
---

<Layout>
  <section class="mb-30 p-3">
    <div class="max-w-3xl mx-auto p-5 sm:p-10 bg-white flex flex-col gap-7 border-3 mt-10">
      
      <button id="back-btn" class="text-gray-600 hover:text-gray-900 flex items-center gap-2 w-fit mb-2 transition-colors cursor-pointer">
        <i class="ri-arrow-left-line text-xl"></i>
        <span class="font-medium">Back</span>
      </button>

      <h1 class="title text-4xl font-black">{project.title}</h1>

      {youtubeEmbedUrl && (
        <div class="aspect-video mb-5 border-2">
          <iframe
            src={youtubeEmbedUrl}
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="w-full h-full"
          ></iframe>
        </div>
      )}

      <div class="relative w-full overflow-hidden bg-gray-100 border-2 py-4">
        <div class="scroll-container">
          <div class="scroll-track">
            {project.media.images.map((imgUrl, index) => (
              <img 
                src={imgUrl} 
                alt={`${project.title} screenshot ${index + 1}`} 
                class="gallery-image border-2 cursor-pointer hover:scale-105 transition-transform duration-200"
                data-index={index}
              />
            ))}
          </div>
          <div class="scroll-track" aria-hidden="true">
            {project.media.images.map((imgUrl, index) => (
              <img 
                src={imgUrl} 
                alt={`${project.title} screenshot ${index + 1}`} 
                class="gallery-image border-2 cursor-pointer hover:scale-105 transition-transform duration-200"
                data-index={index}
              />
            ))}
          </div>
        </div>
      </div>

      <div class="flex border-t border-b border-gray-100 mb-2 py-4">
        <div class="flex-1 flex gap-6">
          <button 
            id="like-btn" 
            class="text-gray-500 flex items-center gap-2 hover:text-gray-700"
            data-endpoint={project.like_info.like_endpoint}
            data-method={project.like_info.method}
            data-liked={project.like_info.user_has_liked.toString()}
          >
            <i id="like-icon" class:list={[
              "ri-thumb-up-line text-xl",
              { "ri-thumb-up-fill text-blue-500": project.like_info.user_has_liked },
            ]}></i>
            <span id="like-count">{project.metrics.like_count}</span>
          </button>
          <a href="#reviews" class="text-gray-500 flex items-center gap-2 hover:text-gray-700">
            <i class="ri-chat-1-line text-xl"></i> {reviews.length}
          </a>
        </div>
      </div>

      <div class="flex flex-wrap gap-4">
        {project.links.live && (
          <a href={project.links.live} target="_blank" class="bg-[var(--blue)] text-black text-md font-medium flex items-center justify-center gap-2 h-12 px-6 border-3 rounded-full flex-1 min-w-[200px] hover:shadow-lg transition-shadow">
            <i class="ri-external-link-line"></i>
            Live Demo
          </a>
        )}
        {project.links.github && (
          <a href={project.links.github} target="_blank" class="bg-gray-800 text-white text-md font-medium flex items-center justify-center gap-2 h-12 px-6 border-3 border-gray-800 rounded-full flex-1 min-w-[200px] hover:shadow-lg transition-shadow">
            <i class="ri-github-fill"></i>
            View on GitHub
          </a>
        )}
      </div>

      <div>
        <div id="project-description" class="text-gray-800 description-clamped" style="white-space: pre-line;">
          {project.description}
        </div>
        <button id="show-more-btn" class="text-blue-600 font-medium mt-2 hidden">
          Show More
        </button>
      </div>

      <div>
        <h3 class="text-lg font-bold mb-3">Technologies Used</h3>
        <div class="flex flex-wrap gap-2">
          {project.technical.technologies.map(tech => (
            <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{tech}</span>
          ))}
        </div>
      </div>

      <div class="text-sm text-gray-500 border-t pt-4">
        <p><strong>Created On:</strong> {formatDate(project.timeline.created_at)}</p>
        <p><strong>Last Updated:</strong> {formatDate(project.timeline.updated_at)}</p>
      </div>
    </div>
  </section>

  <section id="reviews" class="pb-20">
    <div class="max-w-3xl mx-auto px-3">
      
      <h2 class="title text-3xl font-black mb-10">Reviews</h2>
      <div class="grid grid-cols-1 gap-8">
        {reviews.length > 0 ? (
          reviews.map(review => (
            <div class="flex flex-col gap-3 p-5 pr-10 bg-white border-2 shadow-[6px_6px_0px_rgba(0,0,0,0.3)]">
              <div class="flex justify-between items-center">
                <h3 class="font-bold text-lg">{review.title}</h3>
                <div class="flex">
                  {[...Array(5)].map((_, i) => (
                    <i class:list={[
                      "ri-star-fill text-xl",
                      i < review.rating ? "text-yellow-400" : "text-gray-300"
                    ]}></i>
                  ))}
                </div>
              </div>
              <p class="text-gray-700">{review.content}</p>
              <div class="flex items-center gap-2 mt-2 border-t pt-3">
                <h4 class="font-medium">{review.reviewer_name}</h4>
                <span class="text-gray-500 text-sm">- {formatDate(review.created_at)}</span>
              </div>
            </div>
          ))
        ) : (
          <p class="text-gray-600">Be the first to leave a review for this project!</p>
        )}
      </div>

      <div class="mt-20 p-5 sm:p-10 bg-white border-3">
        <h2 class="title text-3xl font-black mb-5">Leave a Review</h2>
        <form id="review-form" class="flex flex-col gap-5">
          <input type="hidden" name="project_id" value={project.id} />
          
          <div id="form-status" class="hidden p-3 rounded-md"></div>

          <div>
            <label class="font-medium mb-2 block">Rating</label>
            <div id="star-rating" class="flex gap-1 text-3xl text-gray-400 cursor-pointer">
              {[...Array(5)].map((_, i) => (
                <i class="star ri-star-line" data-value={i + 1}></i>
              ))}
            </div>
            <input type="hidden" name="rating" id="rating-value" value="0" />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
            <div>
              <label for="reviewer_name" class="font-medium mb-2 block">Your Name</label>
              <input type="text" id="reviewer_name" name="reviewer_name" class="w-full border-2 p-3" required />
            </div>
            <div>
              <label for="reviewer_email" class="font-medium mb-2 block">Your Email</label>
              <input type="email" id="reviewer_email" name="reviewer_email" class="w-full border-2 p-3" required />
            </div>
          </div>

          <div>
            <label for="title" class="font-medium mb-2 block">Review Title</label>
            <input type="text" id="title" name="title" class="w-full border-2 p-3" required />
          </div>

          <div>
            <label for="content" class="font-medium mb-2 block">Review</label>
            <textarea id="content" name="content" rows="4" class="w-full border-2 p-3" required></textarea>
            <small class="text-gray-500 mt-1">Must be at least 10 characters long.</small>
          </div>

          <div class="relative group w-fit">
            <button type="submit" id="submit-btn" class="bg-[var(--blue)] text-black text-md font-medium flex items-center h-12 px-6 border-3 rounded-full">
              Submit Review
            </button>
          </div>
        </form>
      </div>

    </div>
  </section>

  <div id="lightbox-overlay" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
    <button id="lightbox-close" class="absolute top-4 right-6 text-white text-5xl font-bold hover:text-gray-300 transition-colors z-10">&times;</button>
    
    <button id="lightbox-prev" class="absolute left-4 text-white text-5xl font-bold hover:text-gray-300 transition-colors z-10 bg-black bg-opacity-50 w-14 h-14 rounded-full flex items-center justify-center">
      <i class="ri-arrow-left-s-line"></i>
    </button>
    
    <img id="lightbox-image" src="" alt="Enlarged project image" class="max-w-full max-h-full" />
    
    <button id="lightbox-next" class="absolute right-4 text-white text-5xl font-bold hover:text-gray-300 transition-colors z-10 bg-black bg-opacity-50 w-14 h-14 rounded-full flex items-center justify-center">
      <i class="ri-arrow-right-s-line"></i>
    </button>
    
    <div id="lightbox-counter" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-lg font-medium bg-black bg-opacity-50 px-4 py-2 rounded-full">
      1 / 1
    </div>
  </div>

</Layout>

<style>
  .description-clamped {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 5;
  }

  /* Infinite Scroll Animation - Fixed */
  .scroll-container {
    display: flex;
    width: 100%;
  }

  .scroll-track {
    display: flex;
    gap: 1rem;
    padding: 0 0.5rem;
    animation: infinite-scroll 40s linear infinite;
    flex-shrink: 0;
  }

  /* Second track starts where first track ends - no duplicate visible */
  .scroll-track:nth-child(2) {
    animation: infinite-scroll 40s linear infinite;
  }

  .scroll-track:hover {
    animation-play-state: paused;
  }

  .scroll-container:hover .scroll-track {
    animation-play-state: paused;
  }

  .gallery-image {
    height: auto;
    max-height: 12rem;
    width: auto;
    object-fit: contain;
    flex-shrink: 0;
  }

  @keyframes infinite-scroll {
    from {
      transform: translateX(0);
    }
    to {
      transform: translateX(-100%);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    
    // --- Back Button Logic ---
    const backBtn = document.getElementById('back-btn') as HTMLButtonElement;
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        window.history.back();
      });
    }

    // --- "Show More" Description Logic ---
    const description = document.getElementById('project-description') as HTMLElement;
    const showMoreBtn = document.getElementById('show-more-btn') as HTMLButtonElement;
    
    if (description && showMoreBtn) {
      if (description.scrollHeight > description.clientHeight) {
        showMoreBtn.classList.remove('hidden');
      }
      showMoreBtn.addEventListener('click', () => {
        description.classList.toggle('description-clamped');
        showMoreBtn.innerText = description.classList.contains('description-clamped') ? 'Show More' : 'Show Less';
      });
    }

    // --- Image Lightbox Logic with Navigation ---
    const lightboxOverlay = document.getElementById('lightbox-overlay');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxPrev = document.getElementById('lightbox-prev');
    const lightboxNext = document.getElementById('lightbox-next');
    const lightboxCounter = document.getElementById('lightbox-counter');
    const galleryImages = document.querySelectorAll('.gallery-image');
    
    let currentImageIndex = 0;
    const imageUrls: string[] = [];
    
    // Collect unique image URLs
    galleryImages.forEach((img) => {
      const imgElement = img as HTMLImageElement;
      if (!imageUrls.includes(imgElement.src)) {
        imageUrls.push(imgElement.src);
      }
    });

    const updateLightboxImage = (index: number) => {
      currentImageIndex = (index + imageUrls.length) % imageUrls.length;
      lightboxImage.src = imageUrls[currentImageIndex];
      if (lightboxCounter) {
        lightboxCounter.innerText = `${currentImageIndex + 1} / ${imageUrls.length}`;
      }
    };

    const openLightbox = (index: number) => {
      updateLightboxImage(index);
      lightboxOverlay?.classList.remove('hidden');
      lightboxOverlay?.classList.add('flex');
    };

    const closeLightbox = () => {
      lightboxOverlay?.classList.add('hidden');
      lightboxOverlay?.classList.remove('flex');
    };

    if (lightboxOverlay && lightboxImage && lightboxClose && lightboxPrev && lightboxNext) {
      // Open lightbox on image click
      galleryImages.forEach((image, index) => {
        image.addEventListener('click', () => {
          const imgElement = image as HTMLImageElement;
          const imgIndex = imageUrls.indexOf(imgElement.src);
          openLightbox(imgIndex);
        });
      });

      // Close button
      lightboxClose.addEventListener('click', closeLightbox);

      // Previous button
      lightboxPrev.addEventListener('click', (e) => {
        e.stopPropagation();
        updateLightboxImage(currentImageIndex - 1);
      });

      // Next button
      lightboxNext.addEventListener('click', (e) => {
        e.stopPropagation();
        updateLightboxImage(currentImageIndex + 1);
      });

      // Close on overlay click
      lightboxOverlay.addEventListener('click', (e) => {
        if (e.target === lightboxOverlay) closeLightbox();
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!lightboxOverlay?.classList.contains('hidden')) {
          if (e.key === 'Escape') {
            closeLightbox();
          } else if (e.key === 'ArrowLeft') {
            updateLightboxImage(currentImageIndex - 1);
          } else if (e.key === 'ArrowRight') {
            updateLightboxImage(currentImageIndex + 1);
          }
        }
      });
    }

    // --- Like Button Logic ---
    const likeBtn = document.getElementById('like-btn') as HTMLButtonElement;
    const likeCountEl = document.getElementById('like-count');
    const likeIcon = document.getElementById('like-icon');

    if (likeBtn && likeCountEl && likeIcon) {
      const apiBase = 'https://portfolio.triodedevs.workers.dev';
      const endpoint = likeBtn.dataset.endpoint || '';
      const method = likeBtn.dataset.method || 'POST';
      let isLiked = likeBtn.dataset.liked === 'true';
      
      likeBtn.addEventListener('click', async (e) => {
        e.preventDefault(); 
        isLiked = !isLiked;
        let currentLikes = parseInt(likeCountEl.innerText, 10);
        
        if (isLiked) {
          likeCountEl.innerText = (currentLikes + 1).toString();
          likeIcon.classList.remove('ri-thumb-up-line');
          likeIcon.classList.add('ri-thumb-up-fill', 'text-blue-500');
        } else {
          likeCountEl.innerText = (currentLikes - 1).toString();
          likeIcon.classList.add('ri-thumb-up-line');
          likeIcon.classList.remove('ri-thumb-up-fill', 'text-blue-500');
        }

        try {
          const response = await fetch(apiBase + endpoint, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
          });
          if (!response.ok) throw new Error('Like request failed');
          const data = await response.json();
          if (data.like_count !== undefined) {
            likeCountEl.innerText = data.like_count;
          }
        } catch (error) {
          console.error('Error liking project:', error);
          isLiked = !isLiked;
          if (isLiked) {
            likeCountEl.innerText = (currentLikes).toString();
            likeIcon.classList.remove('ri-thumb-up-line');
            likeIcon.classList.add('ri-thumb-up-fill', 'text-blue-500');
          } else {
            likeCountEl.innerText = (currentLikes).toString();
            likeIcon.classList.add('ri-thumb-up-line');
            likeIcon.classList.remove('ri-thumb-up-fill', 'text-blue-500');
          }
        }
      });
    }

    // --- Star Rating Logic ---
    const starRatingContainer = document.getElementById('star-rating');
    const ratingValueInput = document.getElementById('rating-value') as HTMLInputElement;
    if (starRatingContainer && ratingValueInput) {
      const stars = Array.from(starRatingContainer.children) as HTMLElement[];
      const setRating = (value: number) => {
        ratingValueInput.value = value.toString();
        stars.forEach((star, index) => {
          if (index < value) {
            star.classList.remove('ri-star-line');
            star.classList.add('ri-star-fill', 'text-yellow-400');
          } else {
            star.classList.add('ri-star-line');
            star.classList.remove('ri-star-fill', 'text-yellow-400');
          }
        });
      };
      stars.forEach(star => {
        star.addEventListener('click', () => setRating(parseInt(star.dataset.value || '0', 10)));
        star.addEventListener('mouseover', () => {
          const hoverValue = parseInt(star.dataset.value || '0', 10);
          stars.forEach((s, i) => {
            if (i < hoverValue) {
              s.classList.remove('ri-star-line');
              s.classList.add('ri-star-fill', 'text-yellow-400');
            } else {
              s.classList.add('ri-star-line');
              s.classList.remove('ri-star-fill', 'text-yellow-400');
            }
          });
        });
      });
      starRatingContainer.addEventListener('mouseout', () => setRating(parseInt(ratingValueInput.value, 10)));
    }

    // --- Review Form Submission Logic ---
    const reviewForm = document.getElementById('review-form') as HTMLFormElement;
    const formStatus = document.getElementById('form-status');
    const submitBtn = document.getElementById('submit-btn');

    if (reviewForm && formStatus && submitBtn) {
      reviewForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (ratingValueInput.value === '0') {
          showStatus('Please select a star rating.', 'error');
          return;
        }
        submitBtn.setAttribute('disabled', 'true');
        submitBtn.innerText = 'Submitting...';
        const formData = new FormData(reviewForm);
        const payload = {
          project_id: formData.get('project_id') as string,
          reviewer_name: formData.get('reviewer_name') as string,
          reviewer_email: formData.get('reviewer_email') as string,
          title: formData.get('title') as string,
          content: formData.get('content') as string,
          rating: parseInt(formData.get('rating') as string, 10)
        };
        try {
          const response = await fetch('https://portfolio.triodedevs.workers.dev/api/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          
          const responseData = await response.json();
          
          if (response.ok) {
            showStatus(responseData.message || 'Review submitted successfully!', 'success');
            reviewForm.reset();
            (document.getElementById('rating-value') as HTMLInputElement).value = '0';
            const stars = Array.from(starRatingContainer?.children || []) as HTMLElement[];
            stars.forEach(star => {
              star.classList.add('ri-star-line');
              star.classList.remove('ri-star-fill', 'text-yellow-400');
            });
          } else {
            throw new Error(responseData.error || responseData.message || 'Failed to submit review.');
          }
        } catch (error) {
          console.error('Error submitting review:', error);
          let errorMessage = 'Failed to submit review.';
          if (error instanceof Error) errorMessage = error.message;
          showStatus(errorMessage, 'error');
        } finally {
          submitBtn.removeAttribute('disabled');
          submitBtn.innerText = 'Submit Review';
        }
      });
    }

    function showStatus(message: string, type: 'success' | 'error') {
      if (!formStatus) return;
      formStatus.innerText = message;
      formStatus.className = 'p-3 rounded-md';
      if (type === 'success') {
        formStatus.classList.add('bg-green-100', 'text-green-800');
      } else {
        formStatus.classList.add('bg-red-100', 'text-red-800');
      }
    }
  });
</script>